---
title: "Tagfalter-Index 2025: Entwicklung der Einzelarten im Vergleich mit dem BDM"
output:
  powerpoint_presentation:
    reference_doc: ../Settings/template_BDM.pptx
---

```{r setup, include=FALSE}
# Libraries
library(tidyverse)
library(knitr)
library(ggthemes)
library(readxl)

# Knitr settings 
options(scipen = 6);
opts_chunk$set(echo = FALSE, hide = TRUE, cache = FALSE, warning = FALSE, message = FALSE, 
               fig.width = 9, fig.height = 4)

# Darstellung von R-Berechnungen innerhalb von Text
inline_hook <- function(x) {
  if (is.numeric(x)) {
    x <- format(x, nsmall = 2, digits = 2)
  }
  x
}
knit_hooks$set(inline = inline_hook)

# Plot Einstellungen
theme_set(
  theme_clean() +
    theme(
      legend.title = element_blank(), 
      legend.position = "right", 
      legend.background = element_rect(colour = "white"),
      plot.background = element_blank())
)

# Resultate einlesen und Daten auswäheln die Dargestellt werden sollen
species <- read_excel("Tables/Appendix_Species-List_v3.xlsx") %>% 
  filter(Berechnung_TFI %in% c("ja", "BDM"))
resultate <-
  read_csv("Tables/results.csv", col_types = "ciddddddddic") %>% 
  filter(!is.na(match(runID, c("2025_siteoccupancy_v2", "2025_BDM_v5"))))
resultate$quelle <- "TFI"
resultate$quelle[resultate$runID == "2025_BDM_v5"] <- "BDM"
resultate$quelle <- factor(resultate$quelle, levels = c("TFI", "BDM"))
```

## Daten
- Die berechneten Trends des Tagfalterindex basieren auf dem Export der CSCF Daten vom 04.06.2025.
- Die berechneten BDM Trends basieren auf dem Export der BDM Daten vom 02.06.2025.
- Die Nachweise der Arten, die zu einem Aggregat gehören, wurden diesem Aggregat zugeordnet.

## Kurze Modellbeschreibung
- Das Modell analysiert pro Kilometerquadrat und Jahr den Anteil der Meldungen einer Art an der Gesamtzahl der Meldungen aller Arten.
- Das Modell unterscheidet, ob eine Art vorkommt (*Vorkommenswahrscheinlichkeit*) und ob eine Art gemeldet wird, wenn sie vorkommt (*Meldewahrscheinlichkeit*).
- Die Meldewahrscheinlichkeit wird für die folgenden drei Datenquellen geschätzt: CSCF, ornitho und BDM.
- Die Arten werden in unterschiedliche Meldetypen unterteilt.
- Für alle Arten wird der Mittelwert der Vorkommenswahrscheinlichkeit der Jahre 2003-07 auf 100 gesetzt.

## Resultate
- Berechnet wurde der Bestandesindex für alle Arten mit dem gleichen Modell, das für die Unterschiede zwischen Datenquellen und Tagfalter-Meldetypen unterscheidet.
- Bestandestrends wurden für `r n_distinct(resultate$NUESP)` Arten dargestellt. 
- In den folgenden Folien ist der Verlauf des Bestandesindex 1990 bis 2023 für diese Arten abgebildet.
- In den Grafiken ist jeweils der 95% Kompatibiliätsinterval dargestellt.

<!-- Ab hier werden die Slides automatisch generiert -->

```{r, results='asis'}
auswarten <- species$NUESP

for (r in auswarten) {
  # Header
  s <- match(r, species$NUESP)
  cat("## *", species$Species_Name[s], "*\n\n", sep = "")
  
  # Plot machen
  pos <- position_dodge(width = 0.4)
  pl <- 
    resultate %>% 
    filter(NUESP == r) %>% 
    ggplot(aes(x = year, y = STI, col = quelle)) +
    geom_abline(slope = 0, intercept = 100, col = "grey", lty = 2) +
    geom_point(cex = 2, position = pos) +
    geom_line(position = pos) +
    ylim(0, NA) +
    labs(
      # title = paste0(species$ESP[s]),
      subtitle = paste0(
        ifelse(species$Trend_verwenden[s] == "nein", "In TFI verwenden (bisherige Einstufung): nein\n", "In TFI verwenden (bisherige Einstufung): ja\n"),
        ifelse(species$if_n_obs[s] < 400, "In TFI verwenden (nobs > 400): nein\n", "In TFI verwenden (nobs > 400): ja\n")),
      x = "", 
      y = "Index [Mittelwert von 2003-2007 = 100]") +
    scale_color_manual(values=c("black", "orange", "#56B4E9", "blue"))
  pl <- pl + 
    geom_errorbar(aes(ymin = STI_lo, ymax = STI_up), width=.1, lwd = 0.3, position = pos)
  print(pl)
  cat("\n\n")
}
```
